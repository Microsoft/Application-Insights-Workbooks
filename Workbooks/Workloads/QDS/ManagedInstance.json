{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookNames": {
      "type": "object",
      "defaultValue": {
        "QueryWaits": "[guid(resourceGroup().id, 'Query Waits')]",
        "ManagedInstance": "[guid(resourceGroup().id, 'Managed Instance')]",
        "Query": "[guid(resourceGroup().id, 'Query')]",
        "ManagedInstanceDatabase": "[guid(resourceGroup().id, 'Managed Instance Database')]",
        "AlertRules": "[guid(resourceGroup().id, 'Alert Rules')]",
        "LogAlertRule": "[guid(resourceGroup().id, 'Log Alert Rule')]",
        "LogAlertRules": "[guid(resourceGroup().id, 'Log Alert Rules')]"
      }
    }
  },
  "variables": {
    "workbookMarkup": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "7300e9ec-01ec-4c96-8d24-12b843750628",
                "version": "KqlParameterItem/1.0",
                "name": "ResourceId",
                "type": 1,
                "value": "fk-mibc.36c954d642c6.database.windows.net"
              },
              {
                "id": "4ecc9f52-2e3f-4c8e-b9ea-f3e2f2583f5b",
                "version": "KqlParameterItem/1.0",
                "name": "WsResources",
                "type": 1
              },
              {
                "id": "f3e20cbc-b692-4b3d-8916-2fd0662ecfe6",
                "version": "KqlParameterItem/1.0",
                "name": "WsResourcesInternal",
                "type": 5,
                "multiSelect": true,
                "quote": "'",
                "delimiter": ",",
                "query": "where id in~ ({WsResources})\r\n| project id, selected=1",
                "crossComponentResources": [
                  "value::all"
                ],
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
              },
              {
                "id": "30b86356-1bba-4603-83d1-835b99171066",
                "version": "KqlParameterItem/1.0",
                "name": "Timerange",
                "type": 4,
                "value": {
                  "durationMs": 86400000
                },
                "typeSettings": {
                  "selectableValues": [
                    {
                      "durationMs": 300000
                    },
                    {
                      "durationMs": 900000
                    },
                    {
                      "durationMs": 1800000
                    },
                    {
                      "durationMs": 3600000
                    },
                    {
                      "durationMs": 14400000
                    },
                    {
                      "durationMs": 43200000
                    },
                    {
                      "durationMs": 86400000
                    },
                    {
                      "durationMs": 172800000
                    },
                    {
                      "durationMs": 259200000
                    },
                    {
                      "durationMs": 604800000
                    },
                    {
                      "durationMs": 1209600000
                    },
                    {
                      "durationMs": 2419200000
                    },
                    {
                      "durationMs": 2592000000
                    },
                    {
                      "durationMs": 5184000000
                    },
                    {
                      "durationMs": 7776000000
                    }
                  ]
                }
              },
              {
                "id": "4e9f82e1-d302-466b-8f85-2c1966916cf1",
                "version": "KqlParameterItem/1.0",
                "name": "QueryWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Query)]"
              },
              {
                "id": "492550b7-78ea-4b5a-b26b-330cfb499f3e",
                "version": "KqlParameterItem/1.0",
                "name": "MIDBWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').ManagedInstanceDatabase)]"
              },
              {
                "id": "a611e58c-0f45-4ef4-acd3-a43656cb4440",
                "version": "KqlParameterItem/1.0",
                "name": "Type",
                "type": 1,
                "value": "MICROSOFT.SQL/MANAGEDINSTANCES"
              },
              {
                "id": "2f2432a8-bd82-4e71-8465-fac1a22179dd",
                "version": "KqlParameterItem/1.0",
                "name": "managedInstance",
                "type": 5,
                "query": "where type =~ '{Type}'\r\n| where '{ResourceId}' startswith name\r\n| project id, selected = 1",
                "crossComponentResources": [
                  "value::all"
                ],
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
              },
              {
                "id": "1b593c45-5910-4b93-8eb7-b3dadaccf2e9",
                "version": "KqlParameterItem/1.0",
                "name": "dbType",
                "type": 1,
                "value": "AzureSQLManagedInstance"
              },
              {
                "id": "55df770f-e991-47c5-a367-84d8bea544bd",
                "version": "KqlParameterItem/1.0",
                "name": "AlertRulesWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').AlertRules)]"
              },
              {
                "id": "7115697c-a6c2-4dba-8441-6ce4ba5fec83",
                "version": "KqlParameterItem/1.0",
                "name": "LogAlertWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').LogAlertRule)]"
              },
              {
                "id": "4e5e71ad-ec58-4c57-b489-2089cf05dd7d",
                "version": "KqlParameterItem/1.0",
                "name": "LogRulesWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').LogAlertRules)]"
              },
              {
                "id": "5e1b8158-227e-4732-aedc-55f4c082e3f1",
                "version": "KqlParameterItem/1.0",
                "name": "wsQuery",
                "type": 1,
                "query": "let workspaces = dynamic([{WsResources}]);\r\nprint workspaces\r\n| mv-expand(workspaces)\r\n| project line = strcat(\"(workspace('\", Column1, \"').InsightsMetrics| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'| where Namespace == 'sqlserver_azure_db_resource_stats'| where Name == 'avg_cpu_percent'| extend data = todynamic(Tags)| evaluate bag_unpack(data)| where measurement_db_type == '{dbType}'| where sql_instance == '{ResourceId}'| limit 1 | summarize rowCount = count()| where rowCount>0 | project workspace = '\", Column1, \"')\")\r\n| summarize makelist(line)\r\n| project strcat_array(list_line, '\\r\\n| union\\r\\n')",
                "crossComponentResources": [
                  "{WsResourcesInternal}"
                ],
                "typeSettings": {
                  "multiLineText": true,
                  "editorLanguage": "kql"
                },
                "timeContext": {
                  "durationMs": 86400000
                },
                "timeContextFromParameter": "Timerange",
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
              },
              {
                "id": "1678d215-c21c-4acf-a7ea-69a54d421c7d",
                "version": "KqlParameterItem/1.0",
                "name": "wsExact",
                "type": 1,
                "query": "{wsQuery}\r\n| limit 1",
                "crossComponentResources": [
                  "{WsResourcesInternal}"
                ],
                "timeContext": {
                  "durationMs": 0
                },
                "timeContextFromParameter": "Timerange",
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
              },
              {
                "id": "2dbab4a1-4785-4011-aadd-278b974450a3",
                "version": "KqlParameterItem/1.0",
                "name": "IntervalMinutes",
                "type": 1,
                "query": "print {Timerange:grain}/1m",
                "crossComponentResources": [
                  "{WsResourcesInternal}"
                ],
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "conditionalVisibility": {
            "parameterName": "hide",
            "comparison": "isNotEqualTo"
          },
          "name": "parameters - 0"
        },
        {
          "type": 1,
          "content": {
            "json": "# Managed Instance\r\n{managedInstance:name}"
          },
          "name": "text - 1"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "MANAGED INSTANCE RESOURCE USAGE STATS",
            "items": [
              {
                "type": 1,
                "content": {
                  "json": "### CPU utilization"
                },
                "customWidth": "50",
                "name": "text - 4"
              },
              {
                "type": 1,
                "content": {
                  "json": "### Storage used/reserved"
                },
                "customWidth": "50",
                "name": "text - 4 - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "787e1b29-5289-4e7e-91a9-b0ea344949e8",
                      "cellValue": "{managedInstance}",
                      "linkTarget": "AlertCreation",
                      "linkLabel": "New Alert Rule",
                      "style": "link",
                      "alertRuleContext": {
                        "alertType": "Metric",
                        "namespace": "microsoft.sql/managedinstances",
                        "metricId": "microsoft.sql/managedinstances--avg_cpu_percent",
                        "aggregation": 4
                      }
                    },
                    {
                      "id": "7d1b1f9e-8de4-4cd0-a4c4-9e6b8a5fe1ee",
                      "cellValue": "{AlertRulesWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Edit Alert Rules",
                      "style": "link",
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "database",
                            "source": "parameter",
                            "value": "managedInstance"
                          },
                          {
                            "name": "MetricNamespace",
                            "source": "static",
                            "value": "{Type}"
                          },
                          {
                            "name": "MetricCategory",
                            "source": "static",
                            "value": ""
                          },
                          {
                            "name": "MetricName",
                            "source": "static",
                            "value": "avg_cpu_percent"
                          }
                        ]
                      }
                    }
                  ]
                },
                "customWidth": "50",
                "name": "links - 8"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "8935647a-922b-451e-bb16-765b5397e4c9",
                      "cellValue": "{managedInstance}",
                      "linkTarget": "AlertCreation",
                      "linkLabel": "New Alert Rule",
                      "style": "link",
                      "alertRuleContext": {
                        "alertType": "Metric",
                        "namespace": "microsoft.sql/managedinstances",
                        "metricId": "microsoft.sql/managedinstances--storage_space_used_mb",
                        "aggregation": 4
                      }
                    },
                    {
                      "id": "7d1b1f9e-8de4-4cd0-a4c4-9e6b8a5fe1ee",
                      "cellValue": "{AlertRulesWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Edit Alert Rules",
                      "style": "link",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "database",
                            "source": "parameter",
                            "value": "managedInstance"
                          },
                          {
                            "name": "MetricNamespace",
                            "source": "static",
                            "value": "{Type}"
                          },
                          {
                            "name": "MetricCategory",
                            "source": "static",
                            "value": ""
                          },
                          {
                            "name": "MetricName",
                            "source": "static",
                            "value": "storage_space_used_mb"
                          }
                        ]
                      }
                    }
                  ]
                },
                "customWidth": "50",
                "name": "links - 8 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "set truncationmaxrecords=5000;\r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azure_db_resource_stats'\r\n| where Name == 'avg_cpu_percent'\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| summarize cpu = max(todouble(Val)) by bin(TimeGenerated, {Timerange:grain})",
                  "size": 0,
                  "aggregation": 3,
                  "showAnalytics": true,
                  "title": "CPU utilization",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{WsResourcesInternal}"
                  ],
                  "visualization": "linechart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 1,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      },
                      "min": 0,
                      "max": 100
                    }
                  }
                },
                "customWidth": "50",
                "name": "query - 11"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "set truncationmaxrecords=5000;\r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azure_db_resource_stats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| summarize storage_used = max(todouble(storage_space_used_mb)/1024), storage_reserved = max(todouble(reserved_storage_mb)/1024) by bin(TimeGenerated, {Timerange:grain})",
                  "size": 0,
                  "aggregation": 3,
                  "showAnalytics": true,
                  "title": "Storage used/reserved",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{WsResourcesInternal}"
                  ],
                  "visualization": "linechart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 5,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "query - 11 - Copy"
              },
              {
                "type": 1,
                "content": {
                  "json": "### IO requests"
                },
                "customWidth": "50",
                "name": "text - 4 - Copy - Copy"
              },
              {
                "type": 1,
                "content": {
                  "json": "### IO read/write"
                },
                "customWidth": "50",
                "name": "text - 4 - Copy - Copy - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "7e97488e-fa5c-4500-8c62-8143140e8284",
                      "cellValue": "{LogAlertWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "New Alert Rule",
                      "style": "link",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "QueryText",
                            "source": "static",
                            "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend reads = case(physical_filename == prev(physical_filename), reads-prev(reads), real(null)),\r\nwrites = case(physical_filename == prev(physical_filename), writes-prev(writes), real(null))\r\n| summarize AggregatedValue = max(reads+writes) by bin(TimeGenerated, {Timerange:grain})"
                          },
                          {
                            "name": "wsExact",
                            "source": "parameter",
                            "value": "wsExact"
                          },
                          {
                            "name": "ParameterName",
                            "source": "static",
                            "value": "IO Requests"
                          },
                          {
                            "name": "IntervalMinutes",
                            "source": "parameter",
                            "value": "IntervalMinutes"
                          }
                        ]
                      }
                    },
                    {
                      "id": "7d1b1f9e-8de4-4cd0-a4c4-9e6b8a5fe1ee",
                      "cellValue": "{LogRulesWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "View Alert Rules",
                      "style": "link",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "QueryText",
                            "source": "static",
                            "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend reads = case(physical_filename == prev(physical_filename), reads-prev(reads), real(null)),\r\nwrites = case(physical_filename == prev(physical_filename), writes-prev(writes), real(null))\r\n| summarize AggregatedValue = max(reads+writes)"
                          },
                          {
                            "name": "Type",
                            "source": "parameter",
                            "value": "Type"
                          },
                          {
                            "name": "ResourceName",
                            "source": "parameter",
                            "value": "ResourceId"
                          },
                          {
                            "name": "ParameterName",
                            "source": "static",
                            "value": "IO Requests"
                          },
                          {
                            "name": "wsExact",
                            "source": "parameter",
                            "value": "wsExact"
                          }
                        ]
                      }
                    }
                  ]
                },
                "customWidth": "50",
                "name": "links - 8 - Copy - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "fcb12ce7-04af-438a-a775-8daf3d81b1ad",
                      "cellValue": "{LogAlertWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "New Alert Rule (reads)",
                      "style": "link",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "QueryText",
                            "source": "static",
                            "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend io_bytes_read = case(physical_filename == prev(physical_filename), read_bytes-prev(read_bytes), real(null)),\r\nio_bytes_written = case(physical_filename == prev(physical_filename), write_bytes-prev(write_bytes), real(null))\r\n| summarize AggregatedValue = max(toint(io_bytes_read)) by bin(TimeGenerated, {Timerange:grain})"
                          },
                          {
                            "name": "wsExact",
                            "source": "parameter",
                            "value": "wsExact"
                          },
                          {
                            "name": "ParameterName",
                            "source": "static",
                            "value": "IO Reads"
                          },
                          {
                            "name": "IntervalMinutes",
                            "source": "parameter",
                            "value": "IntervalMinutes"
                          }
                        ]
                      }
                    },
                    {
                      "id": "2e70c162-5884-449a-b36d-10a3706ec19c",
                      "cellValue": "{LogAlertWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "New Alert Rule (writes)",
                      "style": "link",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "QueryText",
                            "source": "static",
                            "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend io_bytes_read = case(physical_filename == prev(physical_filename), read_bytes-prev(read_bytes), real(null)),\r\nio_bytes_written = case(physical_filename == prev(physical_filename), write_bytes-prev(write_bytes), real(null))\r\n| summarize AggregatedValue = max(toint(io_bytes_written)) by bin(TimeGenerated, {Timerange:grain})"
                          },
                          {
                            "name": "wsExact",
                            "source": "parameter",
                            "value": "wsExact"
                          },
                          {
                            "name": "ParameterName",
                            "source": "static",
                            "value": "IO Writes"
                          },
                          {
                            "name": "IntervalMinutes",
                            "source": "parameter",
                            "value": "IntervalMinutes"
                          }
                        ]
                      }
                    },
                    {
                      "id": "7d1b1f9e-8de4-4cd0-a4c4-9e6b8a5fe1ee",
                      "cellValue": "{LogRulesWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "View Alert Rules(reads)",
                      "style": "link",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "QueryText",
                            "source": "static",
                            "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend io_bytes_read = case(physical_filename == prev(physical_filename), read_bytes-prev(read_bytes), real(null)),\r\nio_bytes_written = case(physical_filename == prev(physical_filename), write_bytes-prev(write_bytes), real(null))\r\n| summarize AggregatedValue = max(toint(io_bytes_read))"
                          },
                          {
                            "name": "Type",
                            "source": "parameter",
                            "value": "Type"
                          },
                          {
                            "name": "ResourceName",
                            "source": "parameter",
                            "value": "ResourceId"
                          },
                          {
                            "name": "ParameterName",
                            "source": "static",
                            "value": "IO Reads"
                          },
                          {
                            "name": "wsExact",
                            "source": "parameter",
                            "value": "wsExact"
                          }
                        ]
                      }
                    },
                    {
                      "id": "5d321650-c528-4739-8623-26a981dd659c",
                      "cellValue": "{LogRulesWorkbook}",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "View Alert Rules(writes)",
                      "style": "link",
                      "linkIsContextBlade": true,
                      "workbookContext": {
                        "componentIdSource": "workbook",
                        "resourceIdsSource": "workbook",
                        "templateIdSource": "cell",
                        "templateId": "wbLink",
                        "typeSource": "workbook",
                        "gallerySource": "workbook",
                        "locationSource": "default",
                        "passSpecificParams": true,
                        "templateParameters": [
                          {
                            "name": "QueryText",
                            "source": "static",
                            "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend io_bytes_read = case(physical_filename == prev(physical_filename), read_bytes-prev(read_bytes), real(null)),\r\nio_bytes_written = case(physical_filename == prev(physical_filename), write_bytes-prev(write_bytes), real(null))\r\n| summarize AggregatedValue = max(toint(io_bytes_written))"
                          },
                          {
                            "name": "Type",
                            "source": "parameter",
                            "value": "Type"
                          },
                          {
                            "name": "ResourceName",
                            "source": "parameter",
                            "value": "ResourceId"
                          },
                          {
                            "name": "ParameterName",
                            "source": "static",
                            "value": "IO Writes"
                          },
                          {
                            "name": "wsExact",
                            "source": "parameter",
                            "value": "wsExact"
                          }
                        ]
                      }
                    }
                  ]
                },
                "customWidth": "50",
                "name": "links - 8 - Copy - Copy - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "set truncationmaxrecords=5000;\r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend reads = case(physical_filename == prev(physical_filename), reads-prev(reads), real(null)),\r\nwrites = case(physical_filename == prev(physical_filename), writes-prev(writes), real(null))\r\n| summarize requests = max(reads+writes) by bin(TimeGenerated, {Timerange:grain})",
                  "size": 0,
                  "aggregation": 3,
                  "showAnalytics": true,
                  "title": "IO requests",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{WsResourcesInternal}"
                  ],
                  "visualization": "linechart"
                },
                "customWidth": "50",
                "name": "query - 11 - Copy - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "set truncationmaxrecords=5000;\r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance == '{ResourceId}'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend io_bytes_read = case(physical_filename == prev(physical_filename), read_bytes-prev(read_bytes), real(null)),\r\nio_bytes_written = case(physical_filename == prev(physical_filename), write_bytes-prev(write_bytes), real(null))\r\n| summarize read = max(toint(io_bytes_read)), write = max(toint(io_bytes_written)) by bin(TimeGenerated, {Timerange:grain})",
                  "size": 0,
                  "aggregation": 3,
                  "showAnalytics": true,
                  "title": "IO read/write",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{WsResourcesInternal}"
                  ],
                  "visualization": "linechart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 2,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "query - 11 - Copy - Copy - Copy"
              }
            ]
          },
          "customWidth": "70",
          "name": "group - 10"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| distinct database_name, sql_instance\r\n| where database_name != '' and database_name != 'master' and sql_instance != ''\r\n| where sql_instance == '{ResourceId}'\r\n| project Type='{Type}/DATABASES', ResourceId=strcat(sql_instance, '/', database_name)\r\n| extend wbLink = '{MIDBWorkbook}'",
            "size": 2,
            "title": "MANAGED INSTANCE DATABASES",
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "exportFieldName": "ResourceId",
            "exportParameterName": "ResourceId",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{WsResourcesInternal}"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "Type",
                  "formatter": 16,
                  "formatOptions": {
                    "showIcon": true,
                    "customColumnWidthSetting": "4ch"
                  }
                },
                {
                  "columnMatch": "ResourceId",
                  "formatter": 13,
                  "formatOptions": {
                    "linkColumn": "wbLink",
                    "linkTarget": "WorkbookTemplate",
                    "showIcon": true,
                    "customColumnWidthSetting": "100%"
                  }
                },
                {
                  "columnMatch": "wbLink",
                  "formatter": 5
                }
              ],
              "filter": true,
              "labelSettings": [
                {
                  "columnId": "Type",
                  "label": " "
                },
                {
                  "columnId": "ResourceId",
                  "label": "Database"
                },
                {
                  "columnId": "wbLink"
                }
              ]
            }
          },
          "customWidth": "30",
          "name": "query - 10"
        },
        {
          "type": 1,
          "content": {
            "json": "QUERIES"
          },
          "name": "text - 6"
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "913bacd0-f883-483f-b286-75d61236e95e",
                "version": "KqlParameterItem/1.0",
                "name": "query_hash",
                "type": 1,
                "isHiddenWhenLocked": true,
                "timeContext": {
                  "durationMs": 86400000
                }
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "name": "parameters - 17"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "set truncationmaxrecords=5000;\r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_runtime_stats'\r\n| summarize make_bag( pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where sql_instance contains '{ResourceId}'\r\n| summarize max_duration = max(max_duration)/1000000,\r\navg_duration = sum(avg_duration*count_executions)/sum(count_executions)/1000000,\r\navg_cpu = sum(avg_cpu_time*count_executions)/sum(count_executions)/1000000,\r\nexecutions_count = sum(count_executions)\r\n    by query_hash\r\n| join kind=fullouter (\r\n    InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_wait_stats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where strcat(sql_instance,'/',database_name) contains '{ResourceId}'\r\n    | summarize\r\n        avg_wait_duration = sum(total_query_wait_time_ms)/sum(count_executions) / 1000,\r\n        max_wait_duration = max(max_query_wait_time_ms)/1000\r\n        by wait_category, query_hash\r\n    | summarize arg_max(avg_wait_duration, max_wait_duration, wait_category)\r\n        by query_hash\r\n) on query_hash\r\n| project query_hash,\r\n    metric = \"Duration\",\r\n    max_duration,\r\n    avg_duration,\r\n    avg_cpu,\r\n    executions_count,\r\n    wait_category, max_wait_duration, avg_wait_duration,\r\n    wbLink = '{QueryWorkbook}'\r\n| extend resourceIdPrefix = \"{ResourceId}\"\r\n| sort by avg_duration desc",
            "size": 2,
            "showAnalytics": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "exportedParameters": [
              {
                "fieldName": "query_hash",
                "parameterName": "query_hash"
              },
              {
                "fieldName": "query_hash",
                "parameterName": "QueryHash",
                "parameterType": 1
              }
            ],
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{WsResourcesInternal}"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "query_hash",
                  "formatter": 7,
                  "formatOptions": {
                    "linkTarget": "WorkbookTemplate",
                    "workbookContext": {
                      "componentIdSource": "workbook",
                      "resourceIdsSource": "workbook",
                      "templateIdSource": "column",
                      "templateId": "wbLink",
                      "typeSource": "workbook",
                      "gallerySource": "workbook",
                      "locationSource": "default"
                    }
                  }
                },
                {
                  "columnMatch": "max_duration",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "15ch"
                  },
                  "numberFormat": {
                    "unit": 24,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false
                    }
                  }
                },
                {
                  "columnMatch": "avg_duration",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "15ch"
                  },
                  "numberFormat": {
                    "unit": 24,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                {
                  "columnMatch": "avg_cpu",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "15ch"
                  },
                  "numberFormat": {
                    "unit": 24,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                {
                  "columnMatch": "executions_count",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "10ch"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                {
                  "columnMatch": "wait_category",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "20ch"
                  }
                },
                {
                  "columnMatch": "max_wait_duration",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "15ch"
                  },
                  "numberFormat": {
                    "unit": 24,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                {
                  "columnMatch": "avg_wait_duration",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "15ch"
                  },
                  "numberFormat": {
                    "unit": 24,
                    "options": {
                      "style": "decimal"
                    }
                  }
                },
                {
                  "columnMatch": "wbLink",
                  "formatter": 5
                },
                {
                  "columnMatch": "resourceIdPrefix",
                  "formatter": 5
                }
              ],
              "labelSettings": [
                {
                  "columnId": "query_hash",
                  "label": "Query"
                },
                {
                  "columnId": "metric",
                  "label": "Metric"
                },
                {
                  "columnId": "max_duration",
                  "label": "Max"
                },
                {
                  "columnId": "avg_duration",
                  "label": "Avg"
                },
                {
                  "columnId": "avg_cpu",
                  "label": "CPU"
                },
                {
                  "columnId": "executions_count",
                  "label": "Execs"
                },
                {
                  "columnId": "wait_category",
                  "label": "Dominant Wait"
                },
                {
                  "columnId": "max_wait_duration",
                  "label": "Max"
                },
                {
                  "columnId": "avg_wait_duration",
                  "label": "Avg"
                },
                {
                  "columnId": "wbLink"
                },
                {
                  "columnId": "resourceIdPrefix"
                }
              ]
            }
          },
          "customWidth": "60",
          "name": "query - 7"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "items": [
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_runtime_stats'\r\n| summarize make_bag( pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where tostring(sql_instance) contains '{ResourceId}'\r\n| where tostring(query_hash) contains '{query_hash}'\r\n| project interval_start_time, max_duration, cpu_time_d = avg_cpu_time*count_executions, duration_d = avg_duration*count_executions, count_executions_d = count_executions\r\n| summarize avg_duration = sum(duration_d)/sum(count_executions_d)/1000000,\r\navg_cpu = sum(cpu_time_d)/sum(count_executions_d)/1000000\r\n    by bin(interval_start_time, {Timerange:grain})",
                  "size": 0,
                  "title": "Query Duration",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{WsResourcesInternal}"
                  ],
                  "visualization": "linechart"
                },
                "name": "query - 17"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_wait_stats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where tostring(sql_instance) contains '{ResourceId}'\r\n| where tostring(query_hash) contains '{query_hash}'\r\n| summarize total_wait_time = sum(total_query_wait_time_ms)/1000\r\n    by wait_category, bin(interval_start_time, {Timerange:grain})\r\n| top 1000 by total_wait_time desc\r\n| evaluate pivot(wait_category, sum(total_wait_time))\r\n",
                  "size": 0,
                  "title": "Query Waits",
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{WsResourcesInternal}"
                  ],
                  "visualization": "barchart"
                },
                "name": "query - 17 - Copy"
              }
            ]
          },
          "customWidth": "40",
          "name": "group - 19"
        },
        {
          "type": 1,
          "content": {
            "json": "FAILED QUERIES"
          },
          "name": "text - 11"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_runtime_stats'\r\n| summarize make_bag( pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where tostring(sql_instance) contains '{ResourceId}'\r\n| where execution_type==4\r\n| summarize Errors = sum(count_executions) by query_hash\r\n| extend wbLink = '{QueryWorkbook}'",
            "size": 0,
            "showAnalytics": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "exportFieldName": "query_hash",
            "exportParameterName": "QueryHash",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{WsResourcesInternal}"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "query_hash",
                  "formatter": 7,
                  "formatOptions": {
                    "linkTarget": "WorkbookTemplate",
                    "workbookContext": {
                      "componentIdSource": "workbook",
                      "resourceIdsSource": "workbook",
                      "templateIdSource": "column",
                      "templateId": "wbLink",
                      "typeSource": "workbook",
                      "gallerySource": "workbook",
                      "locationSource": "default"
                    }
                  }
                },
                {
                  "columnMatch": "wbLink",
                  "formatter": 5
                }
              ],
              "labelSettings": [
                {
                  "columnId": "query_hash",
                  "label": "Query"
                },
                {
                  "columnId": "Errors"
                },
                {
                  "columnId": "wbLink",
                  "label": "Details"
                }
              ]
            }
          },
          "customWidth": "60",
          "name": "query - 2 - Copy - Copy - Copy"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_runtime_stats'\r\n| summarize make_bag( pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| extend resourceName = tolower(strcat(sql_instance, '/', database_name))\r\n| where tostring(resourceName) contains '{ResourceId}'\r\n| summarize errors = sumif(count_executions, execution_type==4) by TimeGenerated = bin(interval_start_time, {Timerange:grain})",
            "size": 0,
            "showAnalytics": true,
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{WsResourcesInternal}"
            ],
            "visualization": "barchart"
          },
          "customWidth": "40",
          "name": "query - 2 - Copy - Copy"
        }
      ],
      "fallbackResourceIds": [
      ],
      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
    },
    "workbookDisplayName": "Managed Instance",
    "workbookName": "[parameters('workbookNames').ManagedInstance]"
  },
  "resources": [
    {
      "name": "[variables('workbookName')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "kind": "shared",
      "properties": {
        "displayName": "[variables('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookMarkup'))]",
        "version": "Notebook/1.0",
        "sourceId": "[resourceGroup().id]",
        "category": "workbook"
      },
      "tags": {
        "hidden-title": "[variables('workbookDisplayName')]"
      }
    }
  ]
}