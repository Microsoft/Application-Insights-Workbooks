{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookNames": {
      "type": "object",
      "defaultValue": {
        "AlertRule": "[guid(resourceGroup().id, 'Alert Rule')]"
      }
    }
  },
  "variables": {
    "workbookMarkup": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "bfaeb080-dacd-443c-85c0-648a42df1671",
                "version": "KqlParameterItem/1.0",
                "name": "database",
                "type": 1
              },
              {
                "id": "34a33a3b-8300-4054-9c97-2b862b419b1c",
                "version": "KqlParameterItem/1.0",
                "name": "MetricNamespace",
                "type": 1
              },
              {
                "id": "6bcc76c9-a88e-48b0-bca0-7ceba0d5bd02",
                "version": "KqlParameterItem/1.0",
                "name": "MetricCategory",
                "type": 1,
                "value": ""
              },
              {
                "id": "3f7c4a4e-01c3-4ddd-944d-6a737ad3d9af",
                "version": "KqlParameterItem/1.0",
                "name": "MetricName",
                "type": 1
              },
              {
                "id": "a3e55cdd-b16b-4e1a-a36c-dcb6b99ecfb4",
                "version": "KqlParameterItem/1.0",
                "name": "databaseInternal",
                "type": 5,
                "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\":\\\"{database}\\\", \\\"selected\\\" : true}\",\"transformers\":null}",
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 8
              },
              {
                "id": "85764f02-345b-4860-b9ca-c97485b15cac",
                "version": "KqlParameterItem/1.0",
                "name": "LocalizedName",
                "type": 1,
                "query": "{\"version\":\"ARMEndpoint/1.0\",\"data\":null,\"headers\":[],\"method\":\"GET\",\"path\":\"{database}/providers/microsoft.insights/metricDefinitions?api-version=2018-01-01\",\"urlParams\":[],\"batchDisabled\":false,\"transformers\":[{\"type\":\"jsonpath\",\"settings\":{\"tablePath\":\"$.value[?(@.namespace.toLowerCase()==\\\"{MetricNamespace}\\\".toLowerCase() && @.name.value==\\\"{MetricName}\\\")].name.localizedValue\",\"columns\":[]}}]}",
                "queryType": 12
              },
              {
                "id": "c4e8b869-6ec0-40c1-82b3-f178a3eb8dbf",
                "version": "KqlParameterItem/1.0",
                "name": "AlertRuleMetricId",
                "type": 1,
                "query": "{\"version\":\"1.0.0\",\"content\":\"\\\"{MetricNamespace}-{MetricCategory}-{MetricName}\\\"\",\"transformers\":null}",
                "queryType": 8
              }
            ],
            "style": "pills",
            "queryType": 12
          },
          "conditionalVisibility": {
            "parameterName": "hide",
            "comparison": "isNotEqualTo"
          },
          "name": "parameters"
        },
        {
          "type": 1,
          "content": {
            "json": "# Alert Rules\r\n## Database: {databaseInternal:name}  \r\n## Metric: {LocalizedName}"
          },
          "name": "text - 1"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "where type =~ 'microsoft.insights/metricalerts'\r\n| where properties.scopes[0] =~ '{database}'\r\n| where properties.criteria.allOf[0].metricNamespace =~ '{MetricNamespace}'\r\n| where properties.criteria.allOf[0].metricName =~ '{MetricName}'\r\n| extend linkParams = pack(\"alertId\", id, \"alertRule\", pack(\"id\",id, \"name\", name, \"location\", location, \"tags\", tags, \"properties\",properties))\r\n| project Name = name, Aggregation = properties.criteria.allOf[0].timeAggregation, Operator = properties.criteria.allOf[0].operator, Threshold = properties.criteria.allOf[0].threshold, link = strcat(\"https://ms.portal.azure.com/#blade/Microsoft_Azure_Monitoring/UpdateVNextAlertRuleBlade/ruleInputs/\", replace(\"\\\\+\", \"%20\", url_encode(tostring(linkParams))))",
            "size": 0,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "crossComponentResources": [
              "value::all"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "Name",
                  "formatter": 1,
                  "formatOptions": {
                    "linkColumn": "link",
                    "linkTarget": "Url",
                    "bladeOpenContext": {
                      "bladeName": "UpdateVNextAlertRuleBlade",
                      "extensionName": "Microsoft_Azure_Monitoring",
                      "bladeParameters": []
                    }
                  }
                },
                {
                  "columnMatch": "Aggregation",
                  "formatter": 1
                },
                {
                  "columnMatch": "Operator",
                  "formatter": 1
                },
                {
                  "columnMatch": "Threshold",
                  "formatter": 1
                },
                {
                  "columnMatch": "link",
                  "formatter": 5
                }
              ]
            }
          },
          "name": "query - 2"
        }
      ],
      "fallbackResourceIds": [
      ],
      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
    },
    "workbookDisplayName": "Alert Rule",
    "workbookName": "[parameters('workbookNames').AlertRule]"
  },
  "resources": [
    {
      "name": "[variables('workbookName')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "kind": "shared",
      "properties": {
        "displayName": "[variables('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookMarkup'))]",
        "version": "Notebook/1.0",
        "sourceId": "[resourceGroup().id]",
        "category": "workbook"
      },
      "tags": {
        "hidden-title": "[variables('workbookDisplayName')]"
      }
    }
  ]
}