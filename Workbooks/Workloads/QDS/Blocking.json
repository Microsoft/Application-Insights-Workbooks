{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookNames": {
      "type": "object",
      "defaultValue": {
        "Blocking": "[guid(resourceGroup().id, 'Blocking')]",
        "Query": "[guid(resourceGroup().id, 'Query')]"
      }
    }
  },
  "variables": {
    "workbookMarkup": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "crossComponentResources": [
              "{WsResourcesInternal}"
            ],
            "parameters": [
              {
                "id": "7300e9ec-01ec-4c96-8d24-12b843750628",
                "version": "KqlParameterItem/1.0",
                "name": "ResourceId",
                "type": 1
              },
              {
                "id": "4ecc9f52-2e3f-4c8e-b9ea-f3e2f2583f5b",
                "version": "KqlParameterItem/1.0",
                "name": "WsResources",
                "type": 1
              },
              {
                "id": "f3e20cbc-b692-4b3d-8916-2fd0662ecfe6",
                "version": "KqlParameterItem/1.0",
                "name": "WsResourcesInternal",
                "type": 5,
                "query": "where id in~ ({WsResources})\r\n| project id, selected=1",
                "crossComponentResources": [
                  "value::all"
                ],
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
              },
              {
                "id": "30b86356-1bba-4603-83d1-835b99171066",
                "version": "KqlParameterItem/1.0",
                "name": "Timerange",
                "type": 4,
                "value": {
                  "durationMs": 86400000
                },
                "typeSettings": {
                  "selectableValues": [
                    {
                      "durationMs": 300000
                    },
                    {
                      "durationMs": 900000
                    },
                    {
                      "durationMs": 1800000
                    },
                    {
                      "durationMs": 3600000
                    },
                    {
                      "durationMs": 14400000
                    },
                    {
                      "durationMs": 43200000
                    },
                    {
                      "durationMs": 86400000
                    },
                    {
                      "durationMs": 172800000
                    },
                    {
                      "durationMs": 259200000
                    },
                    {
                      "durationMs": 604800000
                    },
                    {
                      "durationMs": 1209600000
                    },
                    {
                      "durationMs": 2419200000
                    },
                    {
                      "durationMs": 2592000000
                    },
                    {
                      "durationMs": 5184000000
                    },
                    {
                      "durationMs": 7776000000
                    }
                  ]
                }
              },
              {
                "id": "2d2c915f-1d47-4be1-b17f-13d0ac55ce43",
                "version": "KqlParameterItem/1.0",
                "name": "EventTime",
                "type": 1
              },
              {
                "id": "128bda6f-44a9-4ea7-94b8-f070763bc568",
                "version": "KqlParameterItem/1.0",
                "name": "QueryWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Query)]"
              },
              {
                "id": "bbc89d92-c4bb-4aef-98cf-39c9a18a92fc",
                "version": "KqlParameterItem/1.0",
                "name": "Type",
                "type": 1
              },
              {
                "id": "668f1adb-a570-4865-99f2-0bb82d52e3bd",
                "version": "KqlParameterItem/1.0",
                "name": "SessionId",
                "type": 1
              },
              {
                "id": "61f30f48-ad25-4e59-9689-5652864b2262",
                "version": "KqlParameterItem/1.0",
                "name": "BlockingSessionId",
                "type": 1
              },
              {
                "id": "d9c0892a-b504-470b-a707-dca8ad3585a1",
                "version": "KqlParameterItem/1.0",
                "name": "dbType",
                "type": 1,
                "value": "AzureSQLDB"
              },
              {
                "id": "f007585c-c99e-47f2-ad48-6400068214a1",
                "version": "KqlParameterItem/1.0",
                "name": "BlockingHash",
                "type": 1,
                "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_requests'\r\n| where TimeGenerated == '{EventTime}'\r\n| summarize make_bag(pack(Name, Val)), make_list(pack('name', Name, 'value', Val)) by Tags\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where session_id == '{BlockingSessionId}'\r\n| project query_hash",
                "crossComponentResources": [
                  "{WsResourcesInternal}"
                ],
                "timeContext": {
                  "durationMs": 0
                },
                "timeContextFromParameter": "Timerange",
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces"
              },
              {
                "version": "KqlParameterItem/1.0",
                "name": "BlockedHash",
                "type": 1,
                "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_requests'\r\n| where TimeGenerated == '{EventTime}'\r\n| summarize make_bag(pack(Name, Val)), make_list(pack('name', Name, 'value', Val)) by Tags\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where session_id == '{SessionId}'\r\n| project query_hash",
                "crossComponentResources": [
                  "{WsResourcesInternal}"
                ],
                "timeContext": {
                  "durationMs": 0
                },
                "timeContextFromParameter": "Timerange",
                "queryType": 0,
                "resourceType": "microsoft.operationalinsights/workspaces",
                "id": "747c532b-d4e3-4cac-9fa4-f26385e10632"
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "conditionalVisibility": {
            "parameterName": "hide",
            "comparison": "isNotEqualTo"
          },
          "name": "parameters - 0"
        },
        {
          "type": 1,
          "content": {
            "json": "# Blocking\r\nTime: {EventTime}"
          },
          "name": "text - 3"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "list",
            "links": [
              {
                "id": "e406ea87-bbac-479e-b126-8959f8a6f298",
                "cellValue": "{QueryWorkbook}",
                "linkTarget": "WorkbookTemplate",
                "linkLabel": "{BlockedHash}",
                "preText": "Blocked query:",
                "style": "link",
                "workbookContext": {
                  "componentIdSource": "workbook",
                  "resourceIdsSource": "workbook",
                  "templateIdSource": "cell",
                  "templateId": "wbLink",
                  "typeSource": "workbook",
                  "gallerySource": "workbook",
                  "locationSource": "default",
                  "passSpecificParams": true,
                  "templateParameters": [
                    {
                      "name": "WsResources",
                      "source": "parameter",
                      "value": "WsResources"
                    },
                    {
                      "name": "Timerange",
                      "source": "parameter",
                      "value": "Timerange"
                    },
                    {
                      "name": "QueryHash",
                      "source": "parameter",
                      "value": "BlockedHash"
                    },
                    {
                      "name": "dbType",
                      "source": "parameter",
                      "value": "dbType"
                    }
                  ]
                }
              },
              {
                "id": "9f1aac38-b8ce-4b81-b545-981e08cb82e5",
                "cellValue": "{QueryWorkbook}",
                "linkTarget": "WorkbookTemplate",
                "linkLabel": "{BlockingHash}",
                "preText": "Blocking query:",
                "style": "link",
                "workbookContext": {
                  "componentIdSource": "workbook",
                  "resourceIdsSource": "workbook",
                  "templateIdSource": "cell",
                  "templateId": "wbLink",
                  "typeSource": "workbook",
                  "gallerySource": "workbook",
                  "locationSource": "default",
                  "passSpecificParams": true,
                  "templateParameters": [
                    {
                      "name": "WsResources",
                      "source": "parameter",
                      "value": "WsResources"
                    },
                    {
                      "name": "Timerange",
                      "source": "parameter",
                      "value": "Timerange"
                    },
                    {
                      "name": "QueryHash",
                      "source": "parameter",
                      "value": "BlockingHash"
                    },
                    {
                      "name": "dbType",
                      "source": "parameter",
                      "value": "dbType"
                    }
                  ]
                }
              }
            ]
          },
          "name": "links - 3"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "let data = InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_requests'\r\n| where TimeGenerated == '{EventTime}'\r\n| summarize make_bag(pack(Name, Val)), make_list(pack('name', Name, 'value', Val)) by Tags\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| where session_id in ('{SessionId}', '{BlockingSessionId}')\r\n| extend Type = case(session_id =='{SessionId}', 'Blocked', 'Blocking');\r\nlet tags = \r\ndata\r\n| summarize buildschema(todynamic(Tags)) by Tags, Type\r\n| mv-expand schema_Tags\r\n| extend Tags = todynamic(Tags)\r\n| extend tag = extract(@'\\{\"([^\"]+)\":\".+\"\\}', 1, tostring(schema_Tags))\r\n| project name = strcat(toupper(substring(tag,0,1)), replace(@'^(.)',@'', replace('_',' ',tag))), Value = Tags[tag], Type;\r\nlet blocking_tags = \r\ntags\r\n| where Type == 'Blocking'\r\n| project name, Blocking = Value;\r\nlet blocked_tags = \r\ntags\r\n| where Type == 'Blocked'\r\n| project name, Blocked = Value;\r\nlet joined_tags = \r\nblocking_tags\r\n| join blocked_tags on name\r\n| project name, Blocking, Blocked;\r\nlet measures = data\r\n| mv-expand list_\r\n| extend name = tostring(list_.name)\r\n| project name = strcat(toupper(substring(name,0,1)), replace(@'^(.)',@'', replace('_',' ',name))), Value = list_.value, Type;\r\nlet blocking_measures = \r\nmeasures\r\n| where Type == 'Blocking'\r\n| project name, Blocking = Value;\r\nlet blocked_measures = \r\nmeasures\r\n| where Type == 'Blocked'\r\n| project name, Blocked = Value;\r\nlet joined_measures = \r\nblocked_measures\r\n| join blocking_measures on name\r\n| project name, Blocking, Blocked;\r\njoined_tags\r\n| union joined_measures",
            "size": 3,
            "title": "Details",
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{WsResourcesInternal}"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "name",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "colors",
                    "thresholdsGrid": [
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "gray",
                        "text": "{0}{1}"
                      }
                    ],
                    "customColumnWidthSetting": "25ch"
                  }
                }
              ],
              "labelSettings": [
                {
                  "columnId": "name",
                  "label": " "
                },
                {
                  "columnId": "Blocking"
                },
                {
                  "columnId": "Blocked"
                }
              ]
            },
            "sortBy": []
          },
          "name": "query - 1 - Copy"
        }
      ],
      "fallbackResourceIds": [
      ],
      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
    },
    "workbookDisplayName": "Blocking",
    "workbookName": "[parameters('workbookNames').Blocking]"
  },
  "resources": [
    {
      "name": "[variables('workbookName')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "kind": "shared",
      "properties": {
        "displayName": "[variables('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookMarkup'))]",
        "version": "Notebook/1.0",
        "sourceId": "[resourceGroup().id]",
        "category": "workbook"
      },
      "tags": {
        "hidden-title": "[variables('workbookDisplayName')]"
      }
    }
  ]
}