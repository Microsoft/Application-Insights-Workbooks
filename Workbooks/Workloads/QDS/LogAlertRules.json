{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookNames": {
      "type": "object",
      "defaultValue": {
        "LogAlertRules": "[guid(resourceGroup().id, 'Log Alert Rules')]"
      }
    }
  },
  "variables": {
    "workbookMarkup": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "14be21d4-ac66-412b-908a-fcb7a0d2be22",
                "version": "KqlParameterItem/1.0",
                "name": "Type",
                "type": 1
              },
              {
                "id": "bfaeb080-dacd-443c-85c0-648a42df1671",
                "version": "KqlParameterItem/1.0",
                "name": "ResourceName",
                "type": 1
              },
              {
                "id": "a83e5b41-4258-46d9-82f9-105867df9ed8",
                "version": "KqlParameterItem/1.0",
                "name": "ParameterName",
                "type": 1
              },
              {
                "id": "0b3fe5e9-1c7e-4540-8022-ce49abac5aff",
                "version": "KqlParameterItem/1.0",
                "name": "TypeInternal",
                "type": 7,
                "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\":\\\"{Type}\\\", \\\"selected\\\":true}\",\"transformers\":null}",
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 8
              },
              {
                "id": "508e0fd4-ccd5-442c-bce5-670d90743bac",
                "version": "KqlParameterItem/1.0",
                "name": "wsExact",
                "type": 1
              },
              {
                "id": "4be5ade6-d8cd-42a9-a031-f00c0df34619",
                "version": "KqlParameterItem/1.0",
                "name": "QueryText",
                "type": 1,
                "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLManagedInstance'\r\n| where sql_instance == 'kdvmigp.60da8ee02807.database.windows.net'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend reads = case(physical_filename == prev(physical_filename), reads-prev(reads), real(null))\r\n| summarize AggregatedValue = max(reads+writes)",
                "typeSettings": {
                  "multiLineText": true,
                  "editorLanguage": "kql"
                }
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "conditionalVisibility": {
            "parameterName": "hide",
            "comparison": "isNotEqualTo"
          },
          "name": "parameters"
        },
        {
          "type": 1,
          "content": {
            "json": "# Alert Rules\r\n## {TypeInternal:label}: {ResourceName}  \r\n## Parameter: {ParameterName}"
          },
          "name": "text - 1"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "where type =~ 'microsoft.insights/scheduledqueryrules'\r\n| where properties.source.dataSourceId =~ '{wsExact}'\r\n| where properties.source.query contains \"{QueryText:escapejson}\"\r\n| project Name = name, Parameter = '{ParameterName}', Operator = properties.action.trigger.thresholdOperator, Threshold = properties.action.trigger.threshold//, link = strcat(\"https://ms.portal.azure.com/#blade/Microsoft_Azure_Monitoring/UpdateVNextAlertRuleBlade/ruleInputs/\", replace(\"\\\\+\", \"%20\", url_encode(tostring(linkParams))))",
            "size": 1,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "crossComponentResources": [
              "value::all"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "Operator",
                  "formatter": 1
                },
                {
                  "columnMatch": "Threshold",
                  "formatter": 1
                }
              ]
            }
          },
          "name": "query - 2"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "list",
            "links": [
              {
                "id": "7ea93f9c-4793-4cdd-903c-e50a16528804",
                "cellValue": "https://ms.portal.azure.com/#@microsoft.onmicrosoft.com/resource{wsExact}/alerts",
                "linkTarget": "Url",
                "linkLabel": "Edit alert rules",
                "style": "link"
              }
            ]
          },
          "name": "links - 3"
        }
      ],
      "fallbackResourceIds": [],
      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
    },
    "workbookDisplayName": "Log Alert Rules",
    "workbookName": "[parameters('workbookNames').LogAlertRules]"
  },
  "resources": [
    {
      "name": "[variables('workbookName')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "kind": "shared",
      "properties": {
        "displayName": "[variables('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookMarkup'))]",
        "version": "Notebook/1.0",
        "sourceId": "[resourceGroup().id]",
        "category": "workbook"
      },
      "tags": {
        "hidden-title": "[variables('workbookDisplayName')]"
      }
    }
  ]
}