{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookNames": {
      "type": "object",
      "defaultValue": {
        "SQLAnalytics": "[guid(resourceGroup().id, 'SQL Analytics')]",
        "Database": "[guid(resourceGroup().id, 'Database')]",
        "ManagedInstance": "[guid(resourceGroup().id, 'Managed Instance')]",
        "ManagedInstanceDatabase": "[guid(resourceGroup().id, 'Managed Instance Database')]",
        "Errors": "[guid(resourceGroup().id, 'Errors')]",
        "Queries": "[guid(resourceGroup().id, 'Queries')]",
        "QueryWaits": "[guid(resourceGroup().id, 'Query Waits')]",
        "Metrics": "[guid(resourceGroup().id, 'Metrics')]",
        "Deadlocks": "[guid(resourceGroup().id, 'Deadlocks')]",
        "Timeouts": "[guid(resourceGroup().id, 'Timeouts')]",
        "DatabaseWaits": "[guid(resourceGroup().id, 'DatabaseWaits')]",
        "Blockings": "[guid(resourceGroup().id, 'Blockings')]"
      }
    }
  },
  "variables": {
    "workbookMarkup": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "1f74ed9a-e3ed-498d-bd5b-f68f3836a117",
                "version": "KqlParameterItem/1.0",
                "name": "Subscription",
                "label": "Subscriptions",
                "type": 6,
                "isRequired": true,
                "multiSelect": true,
                "quote": "'",
                "delimiter": ",",
                "query": "Resources\r\n| where type =~ 'Microsoft.OperationalInsights/workspaces'\r\n| project value = subscriptionId, label = subscriptionId\r\n| distinct value, label",
                "crossComponentResources": [
                  "value::selected"
                ],
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
              },
              {
                "id": "619bf90b-5093-47cc-83a3-bf009257bc7d",
                "version": "KqlParameterItem/1.0",
                "name": "Workspaces",
                "type": 5,
                "isRequired": true,
                "multiSelect": true,
                "quote": "\"",
                "delimiter": ",",
                "query": "where type =~ 'Microsoft.OperationalInsights/workspaces'\n| project id, name",
                "crossComponentResources": [
                  "{Subscription}"
                ],
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
              },
              {
                "id": "4908b8cf-7658-4356-9aa5-5dc5aca7a1aa",
                "version": "KqlParameterItem/1.0",
                "name": "Timerange",
                "label": "Time range",
                "type": 4,
                "value": {
                  "durationMs": 86400000
                },
                "typeSettings": {
                  "selectableValues": [
                    {
                      "durationMs": 1800000
                    },
                    {
                      "durationMs": 3600000
                    },
                    {
                      "durationMs": 14400000
                    },
                    {
                      "durationMs": 43200000
                    },
                    {
                      "durationMs": 86400000
                    },
                    {
                      "durationMs": 172800000
                    },
                    {
                      "durationMs": 259200000
                    },
                    {
                      "durationMs": 604800000
                    },
                    {
                      "durationMs": 1209600000
                    },
                    {
                      "durationMs": 2592000000
                    }
                  ],
                  "allowCustom": true
                }
              },
              {
                "id": "ae6ec2d5-88f9-4924-87f8-8c8e6f7b00b9",
                "version": "KqlParameterItem/1.0",
                "name": "AzureDBWorkbook",
                "type": 1,
                "isHiddenWhenLocked": true,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Database)]"
              },
              {
                "id": "8af872ad-a262-41bb-859d-3f0a714f7784",
                "version": "KqlParameterItem/1.0",
                "name": "WsResources",
                "type": 1,
                "query": "{\"version\":\"1.0.0\",\"content\":\"\\\"{Workspaces:value}\\\"\",\"transformers\":null}",
                "isHiddenWhenLocked": true,
                "queryType": 8
              },
              {
                "id": "423384c4-c43a-447a-b040-36ab00176694",
                "version": "KqlParameterItem/1.0",
                "name": "MIWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').ManagedInstance)]",
                "isHiddenWhenLocked": true
              },
              {
                "id": "4f72c27e-b347-47e9-aa8a-a7f1e31e95a5",
                "version": "KqlParameterItem/1.0",
                "name": "MIDBWorkbook",
                "type": 1,
                "value": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').ManagedInstanceDatabase)]",
                "isHiddenWhenLocked": true
              }
            ],
            "style": "above",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "name": "Parameter block",
          "styleSettings": {
            "margin": "10px 0 15px 0"
          }
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "tabs",
            "links": [
              {
                "id": "fe8477cd-168a-4c71-b332-038a3f2893da",
                "cellValue": "dbType",
                "linkTarget": "parameter",
                "linkLabel": "Azure SQL",
                "subTarget": "AzureSQLDB",
                "preText": "",
                "style": "link"
              },
              {
                "id": "8928aa2a-10a3-42a5-98a8-0f817878dbf4",
                "cellValue": "dbType",
                "linkTarget": "parameter",
                "linkLabel": "Managed Instance",
                "subTarget": "AzureSQLManagedInstance",
                "style": "link"
              }
            ]
          },
          "name": "links - 8"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "let data = \r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| project data = todynamic(Tags)\r\n| project dbType = tostring(data.measurement_db_type), dbName = tostring(data.database_name), serverName = tostring(data.sql_instance)\r\n| distinct dbName, serverName, dbType\r\n| where dbName != '' and serverName != '';\r\ndata\r\n| where ['dbType'] == 'AzureSQLDB'\r\n| summarize DBcount=count() by dbType\r\n| project DisplayType = 'MICROSOFT.SQL/SERVERS/DATABASES', DBcount",
            "size": 4,
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "visualization": "tiles",
            "tileSettings": {
              "titleContent": {
                "columnMatch": "DisplayType",
                "formatter": 16,
                "formatOptions": {
                  "showIcon": true
                }
              },
              "leftContent": {
                "columnMatch": "DBcount",
                "formatter": 12,
                "formatOptions": {
                  "palette": "auto"
                },
                "numberFormat": {
                  "unit": 17,
                  "options": {
                    "style": "decimal",
                    "useGrouping": false,
                    "maximumFractionDigits": 2,
                    "maximumSignificantDigits": 3
                  }
                }
              },
              "showBorder": false
            }
          },
          "conditionalVisibility": {
            "parameterName": "dbType",
            "comparison": "isEqualTo",
            "value": "AzureSQLDB"
          },
          "name": "query - 9"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "let data = \r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| project data = todynamic(Tags) \r\n| project dbType = tostring(data.measurement_db_type), dbName = tostring(data.database_name), serverName = tostring(data.sql_instance)\r\n| distinct dbName, serverName, dbType\r\n| where dbName != '' and serverName != '';\r\ndata\r\n| where ['dbType'] == 'AzureSQLManagedInstance'\r\n| distinct serverName, dbType\r\n| summarize DBcount = count() by dbType\r\n| project DisplayType = 'MICROSOFT.SQL/MANAGEDINSTANCES', DBcount, Order = 1\r\n| union (data\r\n| where ['dbType'] == 'AzureSQLManagedInstance'\r\n| summarize DBcount = count() by dbType\r\n| project DisplayType = 'MICROSOFT.SQL/MANAGEDINSTANCES/DATABASES', DBcount, Order = 2)\r\n| order by Order asc",
            "size": 4,
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "visualization": "tiles",
            "tileSettings": {
              "titleContent": {
                "columnMatch": "DisplayType",
                "formatter": 16,
                "formatOptions": {
                  "showIcon": true
                }
              },
              "leftContent": {
                "columnMatch": "DBcount",
                "formatter": 12,
                "formatOptions": {
                  "palette": "auto"
                },
                "numberFormat": {
                  "unit": 17,
                  "options": {
                    "style": "decimal",
                    "useGrouping": false,
                    "maximumFractionDigits": 2,
                    "maximumSignificantDigits": 3
                  }
                }
              },
              "showBorder": false
            }
          },
          "conditionalVisibility": {
            "parameterName": "dbType",
            "comparison": "isEqualTo",
            "value": "AzureSQLManagedInstance"
          },
          "name": "query - 9 - Copy"
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "95348338-b964-43e1-889a-0e8825057a48",
                "version": "KqlParameterItem/1.0",
                "name": "Type",
                "type": 1,
                "criteriaData": [
                  {
                    "criteriaContext": {
                      "leftOperand": "dbType",
                      "operator": "==",
                      "rightValType": "static",
                      "rightVal": "AzureSQLManagedInstance",
                      "resultValType": "static",
                      "resultVal": "MICROSOFT.SQL/MANAGEDINSTANCES"
                    }
                  },
                  {
                    "criteriaContext": {
                      "operator": "Default",
                      "rightValType": "param",
                      "resultValType": "static",
                      "resultVal": "MICROSOFT.SQL/SERVERS"
                    }
                  }
                ],
                "timeContext": {
                  "durationMs": 86400000
                },
                "value": "MICROSOFT.SQL/SERVERS"
              },
              {
                "id": "21b7a0a9-eeb5-4ee4-9c2d-a1492d67d49c",
                "version": "KqlParameterItem/1.0",
                "name": "Mode",
                "type": 1,
                "criteriaData": [
                  {
                    "criteriaContext": {
                      "leftOperand": "Type",
                      "operator": "contains",
                      "rightValType": "static",
                      "rightVal": "MANAGEDINSTANCES",
                      "resultValType": "static",
                      "resultVal": "Managed Instance"
                    }
                  },
                  {
                    "criteriaContext": {
                      "operator": "Default",
                      "rightValType": "param",
                      "resultValType": "static",
                      "resultVal": "Azure SQL"
                    }
                  }
                ],
                "timeContext": {
                  "durationMs": 86400000
                },
                "value": "Azure SQL"
              },
              {
                "id": "2cf540be-bacf-4393-a51f-cc76bc2f032c",
                "version": "KqlParameterItem/1.0",
                "name": "DBWorkbook",
                "type": 1,
                "criteriaData": [
                  {
                    "criteriaContext": {
                      "leftOperand": "Mode",
                      "operator": "==",
                      "rightValType": "static",
                      "rightVal": "Managed Instance",
                      "resultValType": "param",
                      "resultVal": "MIDBWorkbook"
                    }
                  },
                  {
                    "criteriaContext": {
                      "operator": "Default",
                      "rightValType": "param",
                      "resultValType": "param",
                      "resultVal": "AzureDBWorkbook"
                    }
                  }
                ]
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "conditionalVisibility": {
            "parameterName": "hide",
            "comparison": "isNotEqualTo"
          },
          "name": "parameters - 5"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| project data = todynamic(Tags) \r\n| project dbType = tostring(data.measurement_db_type), dbName = tostring(data.database_name), serverName = tostring(data.sql_instance)\r\n| where ['dbType'] == 'AzureSQLManagedInstance'\r\n| distinct dbName, serverName\r\n| where serverName != '' and dbName != 'master'\r\n| project Type = case(dbName=='', 'MICROSOFT.SQL/MANAGEDINSTANCES', 'MICROSOFT.SQL/MANAGEDINSTANCES/DATABASES'), Resource = case(dbName=='', serverName, strcat(serverName, \"/\", dbName)), wbLink = case(dbName=='', '{MIWorkbook}', '{MIDBWorkbook}')\r\n| extend TypeName = Type\r\n| order by Type asc",
            "size": 0,
            "title": "MANAGED INSTANCE RESOURCES",
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "exportFieldName": "Resource",
            "exportParameterName": "ResourceId",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "Type",
                  "formatter": 16,
                  "formatOptions": {
                    "showIcon": true,
                    "customColumnWidthSetting": "4ch"
                  }
                },
                {
                  "columnMatch": "Resource",
                  "formatter": 7,
                  "formatOptions": {
                    "linkTarget": "WorkbookTemplate",
                    "workbookContext": {
                      "componentIdSource": "workbook",
                      "resourceIdsSource": "workbook",
                      "templateIdSource": "column",
                      "templateId": "wbLink",
                      "typeSource": "workbook",
                      "gallerySource": "workbook",
                      "locationSource": "default"
                    }
                  }
                },
                {
                  "columnMatch": "wbLink",
                  "formatter": 5
                },
                {
                  "columnMatch": "TypeName",
                  "formatter": 16,
                  "formatOptions": {
                    "showIcon": false,
                    "customColumnWidthSetting": "25ch"
                  }
                }
              ],
              "filter": true,
              "labelSettings": [
                {
                  "columnId": "Type",
                  "label": " "
                },
                {
                  "columnId": "Resource"
                },
                {
                  "columnId": "wbLink"
                },
                {
                  "columnId": "TypeName",
                  "label": "Type"
                }
              ]
            }
          },
          "conditionalVisibility": {
            "parameterName": "Mode",
            "comparison": "isEqualTo",
            "value": "Managed Instance"
          },
          "customWidth": "35",
          "name": "query - 4"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "set truncationmaxrecords=5000;\r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azure_db_resource_stats'\r\n| where Name == 'avg_cpu_percent'\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| summarize max_cpu = max(todouble(Val)) by sql_instance, bin(TimeGenerated, {Timerange:grain})",
            "size": 0,
            "aggregation": 3,
            "showAnalytics": true,
            "title": "Managed instances CPU utilization",
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "visualization": "linechart",
            "chartSettings": {
              "ySettings": {
                "numberFormatSettings": {
                  "unit": 1,
                  "options": {
                    "style": "decimal",
                    "useGrouping": true
                  }
                },
                "min": 0,
                "max": 100
              }
            }
          },
          "conditionalVisibility": {
            "parameterName": "Mode",
            "comparison": "isEqualTo",
            "value": "Managed Instance"
          },
          "customWidth": "65",
          "name": "query - 6"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "DATABASE FLEET OVERVIEW",
            "items": [
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "list",
                  "links": [
                    {
                      "id": "b1a725ae-faef-4b34-999b-88eaf6e6cdd1",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Errors)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Number of query errors",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "50",
                "name": "links - 8 - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "list",
                  "links": [
                    {
                      "id": "833dae53-0c82-4d16-ab37-e456831752ab",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Queries)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Query duration in seconds",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "50",
                "name": "links - 8 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_runtime_stats'\r\n| summarize make_bag( pack(Name, Val)) by Tags\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| summarize errors = sumif(count_executions, execution_type==4) by TimeGenerated = bin(interval_start_time, {Timerange:grain})\r\n| sort by TimeGenerated desc",
                  "size": 0,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart"
                },
                "customWidth": "50",
                "name": "query - 7 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_runtime_stats'\r\n| summarize make_bag( pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| extend duration_d = avg_duration*count_executions, cpu_time_d = avg_cpu_time*count_executions, count_executions_d = count_executions\r\n| summarize avg_duration = sum(duration_d)/sum(count_executions_d)/1000000,\r\navg_cpu = sum(cpu_time_d)/sum(count_executions_d)/1000000\r\n    by bin(interval_start_time, {Timerange:grain})",
                  "size": 0,
                  "aggregation": 3,
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "linechart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 24,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "query - 7 - Copy - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "list",
                  "links": [
                    {
                      "id": "b5c423dd-18b8-4d54-bec1-9223028707d2",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').QueryWaits)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Total time queries spent waiting per type",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "50",
                "name": "links - 8 - Copy - Copy"
              },
              {
                "type": 1,
                "content": {
                  "json": ""
                },
                "customWidth": "50",
                "name": "text - 6"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace matches regex 'sqlserver_azure.._querystore_wait_stats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == '{dbType}'\r\n| summarize total_wait_time = sum(total_query_wait_time_ms)/1000\r\n    by wait_category, bin(interval_start_time, {Timerange:grain})\r\n| top 1000 by total_wait_time desc\r\n| evaluate pivot(wait_category, sum(total_wait_time))",
                  "size": 0,
                  "aggregation": 3,
                  "timeContext": {
                    "durationMs": 0
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 24,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "50",
                "name": "query - 7 - Copy - Copy - Copy"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Mode",
            "comparison": "isEqualTo",
            "value": "Managed Instance"
          },
          "name": "group - 15"
        },
        {
          "type": 3,
          "content": {
            "version": "KqlItem/1.0",
            "query": "set truncationmaxrecords=5000;\r\nlet metrics = InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azure_db_resource_stats'\r\n| where Name in ('avg_cpu_percent', 'avg_data_io_percent', 'avg_log_write_percent')\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data);\r\nmetrics\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| where Val > 0 \r\n| summarize metric_value = percentile(min_of(Val, 100.0), 80)by bin(TimeGenerated, {Timerange:grain}), sql_instance, database_name, Name\r\n| summarize arg_max(metric_value, Name) by sql_instance, database_name \r\n| project Resource = strcat(sql_instance, \"/\", database_name).tolower(), MetricName=Name, metric_value\r\n| union ( metrics \r\n| summarize max(Val) by sql_instance, database_name \r\n| where max_Val == 0 \r\n| project Resource = strcat(sql_instance, \"/\", database_name).tolower(), MetricName = \"none\", metric_value = 0.0)\r\n| project Type = 'microsoft.sql/servers/databases', Resource, MetricName, metric_value, wbLink='{DBWorkbook}'\r\n| sort by metric_value desc",
            "size": 0,
            "title": "TOP METRIC UTILIZATION PER DATABASE",
            "timeContext": {
              "durationMs": 86400000
            },
            "timeContextFromParameter": "Timerange",
            "exportFieldName": "Resource",
            "exportParameterName": "ResourceId",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces",
            "crossComponentResources": [
              "{Workspaces}"
            ],
            "gridSettings": {
              "formatters": [
                {
                  "columnMatch": "Type",
                  "formatter": 16,
                  "formatOptions": {
                    "showIcon": true,
                    "customColumnWidthSetting": "4ch"
                  }
                },
                {
                  "columnMatch": "Resource",
                  "formatter": 7,
                  "formatOptions": {
                    "linkTarget": "WorkbookTemplate",
                    "workbookContext": {
                      "componentIdSource": "workbook",
                      "resourceIdsSource": "workbook",
                      "templateIdSource": "column",
                      "templateId": "wbLink",
                      "typeSource": "workbook",
                      "gallerySource": "workbook",
                      "locationSource": "default"
                    }
                  }
                },
                {
                  "columnMatch": "MetricName",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "20ch"
                  }
                },
                {
                  "columnMatch": "metric_value",
                  "formatter": 0,
                  "formatOptions": {
                    "customColumnWidthSetting": "11ch"
                  },
                  "numberFormat": {
                    "unit": 1,
                    "options": {
                      "style": "decimal",
                      "useGrouping": false
                    }
                  }
                },
                {
                  "columnMatch": "wbLink",
                  "formatter": 5
                }
              ],
              "filter": true,
              "labelSettings": [
                {
                  "columnId": "Type",
                  "label": " "
                },
                {
                  "columnId": "Resource"
                },
                {
                  "columnId": "MetricName",
                  "label": "Metric"
                },
                {
                  "columnId": "metric_value",
                  "label": "80th Percentile"
                },
                {
                  "columnId": "wbLink"
                }
              ]
            },
            "sortBy": []
          },
          "conditionalVisibility": {
            "parameterName": "Mode",
            "comparison": "isEqualTo",
            "value": "Azure SQL"
          },
          "customWidth": "30",
          "name": "query - 15"
        },
        {
          "type": 12,
          "content": {
            "version": "NotebookGroup/1.0",
            "groupType": "editable",
            "title": "DATABASE FLEET OVERVIEW",
            "items": [
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "298d3e49-deeb-4e8b-9799-6c383c3139f5",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Metrics)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Resources per utilization bucket",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "4f7a50df-8010-413c-b85d-043c126024d3",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Queries)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Query duration in seconds",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11 - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "9558bd60-44ee-4ff7-89e4-c4d8a6e94a21",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Errors)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Number of query errors",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "set truncationmaxrecords=5000;\r\nlet metrics = InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azure_db_resource_stats'\r\n| where Name in ('avg_cpu_percent', 'avg_data_io_percent', 'avg_log_write_percent')\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB';\r\nmetrics\r\n| summarize Val = percentile(Val, 80) by Name, sql_instance, database_name, bin(TimeGenerated, {Timerange:grain})\r\n| summarize max_val = max(Val) by sql_instance, database_name, TimeGenerated\r\n| extend category = case(max_val < 20, \"low\", max_val < 80, \"medium\", \"high\")\r\n| summarize high = countif(category == \"high\"), medium = countif(category == \"medium\"), low = countif(category == \"low\") by TimeGenerated\r\n",
                  "size": 1,
                  "aggregation": 5,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart",
                  "chartSettings": {
                    "seriesLabelSettings": [
                      {
                        "seriesName": "high",
                        "color": "orange"
                      },
                      {
                        "seriesName": "medium",
                        "color": "green"
                      },
                      {
                        "seriesName": "low",
                        "color": "blue"
                      }
                    ],
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 17,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "33",
                "name": "query - 17"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azuredb_querystore_runtime_stats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| extend duration_d = avg_duration * count_executions, cpu_time_d = avg_cpu_time * count_executions, count_executions_d = count_executions\r\n| summarize avg_duration = sum(duration_d)/sum(count_executions_d)/1000000,\r\navg_cpu = sum(cpu_time_d)/sum(count_executions_d)/1000000\r\n    by bin(interval_start_time, {Timerange:grain})",
                  "size": 1,
                  "aggregation": 3,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "linechart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 24,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "33",
                "name": "query - 1"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azuredb_querystore_runtime_stats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| summarize errors = sumif(count_executions, execution_type==4) by TimeGenerated = bin(interval_start_time, {Timerange:grain})\r\n| sort by TimeGenerated desc",
                  "size": 1,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart"
                },
                "customWidth": "33",
                "name": "query - 2"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "ede5179f-ffc9-45ec-b03b-7aa21473350a",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Deadlocks)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Number of deadlock events",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11 - Copy - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "ecde842c-59a0-442f-aee8-1bea16e6d44f",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').QueryWaits)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Total time queries spent waiting per type",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11 - Copy - Copy - Copy - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "1ed210a3-2a14-448d-9a5c-8af5f5366a2a",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Timeouts)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Number of timeouts",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11 - Copy - Copy - Copy - Copy - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_performance'\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| extend resourceName = tolower(strcat(extract(\"^([^\\\\.]+)\\\\.?\", 1, sql_instance), '/', database_name))\r\n| where counter == 'Number of Deadlocks/sec'\r\n| order by resourceName, TimeGenerated asc\r\n| serialize\r\n| extend delta = case(prev(resourceName) == resourceName, case(Val>=prev(Val), Val - prev(Val), Val), real(null))\r\n| summarize deadlocks = sum(delta) by bin(TimeGenerated, {Timerange:grain})",
                  "size": 1,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart"
                },
                "customWidth": "33",
                "name": "query - 2 - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azuredb_querystore_wait_stats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| summarize total_wait_time = sum(total_query_wait_time_ms)/1000\r\n    by wait_category, bin(interval_start_time, {Timerange:grain})\r\n| top 1000 by total_wait_time desc\r\n| evaluate pivot(wait_category, sum(total_wait_time))",
                  "size": 1,
                  "aggregation": 3,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 24,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "33",
                "name": "query - 2 - Copy - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_performance'\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| extend resourceName = tolower(strcat(extract(\"^([^\\\\.]+)\\\\.?\", 1, sql_instance), '/', database_name))\r\n| where counter == 'Lock Timeouts (timeout > 0)/sec'\r\n| order by resourceName, TimeGenerated asc\r\n| serialize\r\n| extend delta = case(prev(resourceName) == resourceName, case(Val>=prev(Val), Val - prev(Val), Val), real(null))\r\n| summarize timeouts = max(delta) by bin(TimeGenerated, {Timerange:grain})\r\n| sort by TimeGenerated desc",
                  "size": 1,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart"
                },
                "customWidth": "32",
                "name": "query - 2 - Copy - Copy - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "123ba7a3-dac4-4764-a1e2-43bfc32e7a70",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').DatabaseWaits)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Total time DBs spent waiting per type",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy"
              },
              {
                "type": 11,
                "content": {
                  "version": "LinkItem/1.0",
                  "style": "nav",
                  "links": [
                    {
                      "id": "35ef9aac-4af4-42ee-8fd8-f552d8d56236",
                      "cellValue": "[resourceId('microsoft.insights/workbooks', parameters('workbookNames').Blockings)]",
                      "linkTarget": "WorkbookTemplate",
                      "linkLabel": "Number of blocking events",
                      "style": "link"
                    }
                  ]
                },
                "customWidth": "33",
                "name": "links - 11 - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy - Copy"
              },
              {
                "type": 1,
                "content": {
                  "json": ""
                },
                "customWidth": "33",
                "name": "text - 22"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "set truncationmaxrecords=5000;\r\nInsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_azuredb_waitstats'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| where database_name!=''\r\n| extend resourceName = tolower(strcat(extract(\"^([^\\\\.]+)\\\\.?\", 1, sql_instance), '/', database_name))\r\n| order by resourceName, wait_type, TimeGenerated asc\r\n| serialize \r\n| project TimeGenerated, wait_time_ms = case(prev(resourceName) == resourceName and prev(wait_type) == wait_type, wait_time_ms - prev(wait_time_ms), real(null)), wait_type\r\n| summarize total_wait_time_in_ms = sum(wait_time_ms)/1000\r\n    by wait_type, bin(TimeGenerated, {Timerange:grain})\r\n| top 1000 by total_wait_time_in_ms desc\r\n| evaluate pivot(wait_type, sum(total_wait_time_in_ms))",
                  "size": 1,
                  "aggregation": 3,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart",
                  "chartSettings": {
                    "ySettings": {
                      "numberFormatSettings": {
                        "unit": 24,
                        "options": {
                          "style": "decimal",
                          "useGrouping": true
                        }
                      }
                    }
                  }
                },
                "customWidth": "33",
                "name": "query - 2 - Copy - Copy"
              },
              {
                "type": 3,
                "content": {
                  "version": "KqlItem/1.0",
                  "query": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_performance'\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLDB'\r\n| extend resourceName = tolower(strcat(extract(\"^([^\\\\.]+)\\\\.?\", 1, sql_instance), '/', database_name))\r\n| where counter == 'Lock Waits/sec'\r\n| order by resourceName, TimeGenerated asc\r\n| serialize\r\n| extend delta = case(prev(resourceName) == resourceName, case(Val>=prev(Val), Val - prev(Val), Val), real(null))\r\n| summarize blockings = max(delta) by bin(TimeGenerated, {Timerange:grain})\r\n| sort by TimeGenerated desc",
                  "size": 1,
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "timeContextFromParameter": "Timerange",
                  "queryType": 0,
                  "resourceType": "microsoft.operationalinsights/workspaces",
                  "crossComponentResources": [
                    "{Workspaces}"
                  ],
                  "visualization": "barchart"
                },
                "customWidth": "33",
                "name": "query - 2 - Copy - Copy - Copy"
              }
            ]
          },
          "conditionalVisibility": {
            "parameterName": "Mode",
            "comparison": "isEqualTo",
            "value": "Azure SQL"
          },
          "customWidth": "70",
          "name": "group - 16"
        }
      ],
      "fallbackResourceIds": [
      ],
      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
    },
    "workbookDisplayName": "SQL Analytics",
    "workbookName": "[parameters('workbookNames').SQLAnalytics]"
  },
  "resources": [
    {
      "name": "[variables('workbookName')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "kind": "shared",
      "properties": {
        "displayName": "[variables('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookMarkup'))]",
        "version": "Notebook/1.0",
        "sourceId": "[resourceGroup().id]",
        "category": "workbook"
      },
      "tags": {
        "hidden-title": "[variables('workbookDisplayName')]"
      }
    }
  ]
}