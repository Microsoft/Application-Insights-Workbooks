{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookNames": {
      "type": "object",
      "defaultValue": {
        "LogAlertRule": "[guid(resourceGroup().id, 'Log Alert Rule')]"
      }
    }
  },
  "variables": {
    "workbookMarkup": {
      "version": "Notebook/1.0",
      "items": [
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "95013231-5597-4abc-a4a3-ff7b8424a831",
                "version": "KqlParameterItem/1.0",
                "name": "QueryText",
                "type": 1,
                "value": "InsightsMetrics\r\n| where Origin == 'solutions.azm.ms/telegraf/SqlInsights'\r\n| where Namespace == 'sqlserver_database_io'\r\n| summarize make_bag(pack(Name, Val)) by Tags, TimeGenerated\r\n| evaluate bag_unpack(bag_)\r\n| extend data = todynamic(Tags)\r\n| evaluate bag_unpack(data)\r\n| where measurement_db_type == 'AzureSQLManagedInstance'\r\n| where sql_instance == 'kdvmigp.60da8ee02807.database.windows.net'\r\n| order by physical_filename, TimeGenerated asc\r\n| serialize \r\n| extend reads = case(physical_filename == prev(physical_filename), reads-prev(reads), real(null)),\r\nwrites = case(physical_filename == prev(physical_filename), writes-prev(writes), real(null))\r\n| summarize requests = max(reads+writes) by bin(TimeGenerated, 30m)",
                "typeSettings": {
                  "multiLineText": true,
                  "editorLanguage": "kql"
                },
                "timeContext": {
                  "durationMs": 86400000
                }
              },
              {
                "id": "41e93303-ad2d-46b0-8ad7-66da9e538b72",
                "version": "KqlParameterItem/1.0",
                "name": "wsExact",
                "type": 1,
                "timeContext": {
                  "durationMs": 86400000
                }
              },
              {
                "id": "d355e5f6-12cd-4d30-aa21-c606645354d2",
                "version": "KqlParameterItem/1.0",
                "name": "wsExactInternal",
                "type": 5,
                "query": "{\"version\":\"1.0.0\",\"content\":\"{\\\"value\\\":\\\"{wsExact}\\\", \\\"selected\\\":true}\",\"transformers\":null}",
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "timeContext": {
                  "durationMs": 86400000
                },
                "queryType": 8
              },
              {
                "id": "639c989e-66a9-4842-b8ed-0ffcee6cf276",
                "version": "KqlParameterItem/1.0",
                "name": "resourceGroup",
                "type": 1,
                "query": "{\"version\":\"1.0.0\",\"content\":\"\\\"/subscriptions/{wsExactInternal:subscription}/resourceGroups/{wsExactInternal:resourceGroup}\\\"\",\"transformers\":null}",
                "timeContext": {
                  "durationMs": 86400000
                },
                "queryType": 8
              },
              {
                "id": "b626d679-0808-4af0-afe9-d5087a8b07fd",
                "version": "KqlParameterItem/1.0",
                "name": "ParameterName",
                "type": 1,
                "value": "IO Requests",
                "timeContext": {
                  "durationMs": 86400000
                }
              },
              {
                "id": "8709281d-191d-4d8b-8c5a-1a979cb2b9fa",
                "version": "KqlParameterItem/1.0",
                "name": "IntervalMinutes",
                "type": 1,
                "value": "30",
                "timeContext": {
                  "durationMs": 86400000
                }
              }
            ],
            "style": "pills",
            "queryType": 0,
            "resourceType": "microsoft.operationalinsights/workspaces"
          },
          "conditionalVisibility": {
            "parameterName": "hide",
            "comparison": "isNotEqualTo"
          },
          "name": "parameters - 0"
        },
        {
          "type": 1,
          "content": {
            "json": "Alert will fire when maximum of {ParameterName} over the last {IntervalMinutes} minutes breaches the threshold.  \r\nYou can adjust the query frequency, the time interval and the repeat count later."
          },
          "name": "text - 2"
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "crossComponentResources": [
              "value::selected"
            ],
            "parameters": [
              {
                "id": "dcc58ea4-4696-40ed-862e-7368d590b501",
                "version": "KqlParameterItem/1.0",
                "name": "Operator",
                "type": 2,
                "value": null,
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "jsonData": "[[\r\n    {\"value\":\"GreaterThan\", \"label\":\"Greater Than\"},\r\n    {\"value\":\"LessThan\", \"label\":\"Less Than\"},\r\n    {\"value\":\"Equal\", \"label\":\"Equal\"}\r\n]",
                "timeContext": {
                  "durationMs": 86400000
                }
              },
              {
                "id": "3d75d0f2-01f7-4e0f-9bfe-8f73bbdb666b",
                "version": "KqlParameterItem/1.0",
                "name": "Threshold",
                "type": 1,
                "value": "",
                "typeSettings": {
                  "paramValidationRules": [
                    {
                      "regExp": "^\\d+(\\.(\\d+))?$",
                      "match": true,
                      "message": "The value must be a number"
                    }
                  ]
                },
                "timeContext": {
                  "durationMs": 86400000
                }
              },
              {
                "id": "eb1cb9c2-a6bd-4a5a-b5ef-ea7e917f29cc",
                "version": "KqlParameterItem/1.0",
                "name": "ActionGroup",
                "label": "Action Group",
                "type": 5,
                "multiSelect": true,
                "quote": "\"",
                "delimiter": ",",
                "query": "where subscriptionId == '{wsExactInternal:subscription}'\r\n| where type =~ 'microsoft.insights/actiongroups'\r\n| project id, selected = false",
                "crossComponentResources": [
                  "value::selected"
                ],
                "value": [],
                "typeSettings": {
                  "additionalResourceOptions": [],
                  "showDefault": false
                },
                "queryType": 1,
                "resourceType": "microsoft.resourcegraph/resources"
              }
            ],
            "style": "above",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          "name": "parameters - 1"
        },
        {
          "type": 9,
          "content": {
            "version": "KqlParameterItem/1.0",
            "parameters": [
              {
                "id": "c44eaad6-2e1f-4c0e-968b-cec052cafee2",
                "version": "KqlParameterItem/1.0",
                "name": "RuleName",
                "label": "Alert Rule Name",
                "type": 1,
                "query": "{\"version\":\"1.0.0\",\"content\":\"\\\"{ParameterName} is {Operator:label} {Threshold}\\\"\",\"transformers\":null}",
                "timeContext": {
                  "durationMs": 86400000
                },
                "queryType": 8
              }
            ],
            "style": "formVertical",
            "queryType": 8
          },
          "name": "parameters - 4"
        },
        {
          "type": 11,
          "content": {
            "version": "LinkItem/1.0",
            "style": "list",
            "links": [
              {
                "id": "46277bf3-2693-4209-b8fb-81d26c81192d",
                "cellValue": "f",
                "linkTarget": "ArmTemplate",
                "linkLabel": "Create Alert Rule",
                "preText": "",
                "style": "primary",
                "linkIsContextBlade": true,
                "templateRunContext": {
                  "componentIdSource": "parameter",
                  "componentId": "resourceGroup",
                  "templateUriSource": "static",
                  "templateUri": "https://pmarmtemplates.blob.core.windows.net/templates/logAlert.json",
                  "templateParameters": [
                    {
                      "name": "alertRuleName",
                      "source": "parameter",
                      "value": "RuleName",
                      "kind": "stringValue"
                    },
                    {
                      "name": "workspaceId",
                      "source": "parameter",
                      "value": "wsExact",
                      "kind": "stringValue"
                    },
                    {
                      "name": "queryText",
                      "source": "parameter",
                      "value": "QueryText",
                      "kind": "stringValue"
                    },
                    {
                      "name": "frequency",
                      "source": "parameter",
                      "value": "IntervalMinutes",
                      "kind": "intValue"
                    },
                    {
                      "name": "actionGroup",
                      "source": "static",
                      "value": "[[{ActionGroup}]",
                      "kind": "arrayValue"
                    },
                    {
                      "name": "operator",
                      "source": "parameter",
                      "value": "Operator",
                      "kind": "stringValue"
                    },
                    {
                      "name": "threshold",
                      "source": "parameter",
                      "value": "Threshold",
                      "kind": "intValue"
                    }
                  ],
                  "titleSource": "static",
                  "title": "Alert Rule Deployment",
                  "descriptionSource": "static",
                  "runLabelSource": "static",
                  "runLabel": "Deploy"
                }
              }
            ]
          },
          "name": "links - 3"
        }
      ],
      "fallbackResourceIds": [
      ],
      "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
    },
    "workbookDisplayName": "Log Alert Rule",
    "workbookName": "[parameters('workbookNames').LogAlertRule]"
  },
  "resources": [
    {
      "name": "[variables('workbookName')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2018-06-17-preview",
      "kind": "shared",
      "properties": {
        "displayName": "[variables('workbookDisplayName')]",
        "serializedData": "[string(variables('workbookMarkup'))]",
        "version": "Notebook/1.0",
        "sourceId": "[resourceGroup().id]",
        "category": "workbook"
      },
      "tags": {
        "hidden-title": "[variables('workbookDisplayName')]"
      }
    }
  ]
}